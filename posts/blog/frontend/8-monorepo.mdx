---
title: 모노레포 적용하기 (yarn workspace, turborepo)
description:
image: '/posts/8-monorepo/cover.png'
tags:
  - 모노레포
  - yarn workspace
  - turborepo

date: 2023-09-03 18:35:25
---

> ## 글을 시작하며

프로젝트가 성장하면서 규모가 커질 때 우리는 효율적인 프로젝트 구조를 고민합니다.
Google, Facebook, Microsoft 등 글로벌 테크 회사들은 이미 각자의 전략 아래 대규모 모노레포를 운영하고 있습니다.
이번 글에서는 모노레포의 도입 배경과 yarn workspace, turborepo를 이용하여 모노레포를 구축하는 방법에 대해서 알아보겠습니다.

---

## 모노레포의 등장 배경

모노레포란 멀티레포와 반대되는 개념으로 **두 개 이상의 프로젝트 코드를 하나의 레포지토리에서 관리**하는 방식을 의미합니다.

모노레포는 멀티레포의 문제점들을 어떻게 해결하였는지 함께 살펴보겠습니다.

### 모노레포가 해결한 문제

- **프로젝트 생성에 대한 오버헤드 감소**
  멀티레포에서는 공유 패키지를 만들 때 매번 다음과 같은 과정을 거칩니다.

  > 저장소 생성 > 커미터 추가 > 개발환경 구축 > CI/CD 구축 > 빌드 > 패키지 저장소에 publish

  하지만 모노레포에서는 **기존의 DevOps를 이용**하므로 새로운 프로젝트 생성에 대한 오버헤드가 없습니다.

- **쉬운 패키지 공유**
  멀티 레포의 경우 패키지 간 공유가 쉽지 않기 때문에 중복 코드가 발생할 위험이 있지만, 모노 레포의 경우 **모듈에 대한 공유**가 수월하기 때문에 **중복 코드가 발생할 위험이 적습니다.**

- **일관된 개발자 경험**
  애플리케이션을 일관되게 구축하고 테스트할 수 있습니다. 하나의 저장소에서 패키지들을 관리하기 때문에 **이슈 트래킹을 분산 없이 하나로 처리**가 가능합니다.

> 기술을 도입할 때는 단점 또한 분명히 파악하는 것이 중요합니다.

<br />

### 모노레포의 단점

- **용량 문제와 성능 이슈**
  멀티레포 구조에서는 필요한 프로젝트만 설치할 수 있지만 모노레포에서는 프로젝트들의 모든 리소스를 관리하기 때문에 용량과 성능면에서 문제가 생길 수 있습니다.

- **느린 CI Build**
  멀티 레포와 반대로 CI가 하나로 구성된다는 장점이 있지만, 패키지 규모가 커짐으로써 **분산된 CI Build보다 속도가 느릴 수** 밖에 없습니다.

- **무분별한 의존성**
  하나의 저장소에서 관리하기 때문에 패키지 간의 의존성 관리가 쉽다는 장점이 있지만 오히려 **과도한 의존 관계**가 나타날 수 있습니다.

> 그렇다면 모노레포를 어떤 상황에서 도입하는게 적절할까요?

<br />

### 모노레포 고려 상황

- 서로 다른 패키지가 연관 관계를 가질 경우
- **N개의 패키지의 형태와 목적이 유사**한 경우
- **N개의 패키지 중 배포되어야 할 패키지의 비중이 큰** 경우

저의 경우 현업에서 웹뷰 서비스를 개발하면서 모노레포를 도입하였습니다.
배경은 **하나의 디자인 시스템을 따르는 5가지 서비스의 웹뷰**를 빠르게 개발해내는 것이 필요했습니다.

따라서 아래 세 가지를 요소를 효율적으로 처리하는 것이 중요하였고 모노레포의 장점을 활용해볼 수 있겠다는 판단이 들었습니다.

- 세팅 시간 단축
- 공통 컴포넌트 관리
- 이슈 트래킹을 한 번에 처리

지금부터는 `모노레포를 구성하는 방법`과 `모노레포의 단점을 극복`하기 위해 시도했던 방법들에 대해서 공유하고자 합니다.

---

## 모노레포 구축 툴

모노레포를 구축하기 위해 사용되는 툴은 Yarn workspace, Turborepo, Lerna, Nx 등이 있습니다.

![230904-231926](/posts/8-monorepo/230904-231926.png)

이번 글에서는 Yarn workspace와 Turborepo에 집중해보겠습니다.

#### 1. Yarn workspace

- yarn berry와 호환성이 좋으며 간단하게 모노레포를 구성할 수 있습니다.

#### 2. Turborepo

- 가장 최근에 출시되었으며 Vercel에서 운영하고 있습니다.
- 초기 설정이 쉬우며 병렬처리 기법과 원격 캐싱을 이용해서 빌드 속도가 빠른 장점이 있습니다.

---

## Yarn workspace

저는 현업에서 yarn workspace를 이용하여 모노레포를 구축하였습니다.
그 이유는 `yarn berry`를 사용하여 **모노레포의 단점을 극복**하기 위함이었습니다.

### 채택 이유

- #### CI 빌드 시간 단축

  모노레포에서는 node_modules를 루트 위치에 두고 있기 때문에 프로젝트가 많아질 수록 `빌드 속도`가 느려지고 사용하지 않는 패키지를 설치하는 `의존성 문제`가 있었습니다.

  > 따라서 yarn berry의 PnP 방식을 도입하여 node_modules의 문제를 해결하고자 하였습니다.

  결론적으로는 yarn berry를 사용하여 `의존성 크기를 60% 가량 줄이고` `빌드 시간을 1분 이상 단축`할 수 있었습니다.

- #### yarn berry와의 호환성
  Turborepo의 경우 yarn berry의 PnP 모드가 온전히 지원되지 않기 때문에
  yarn berry와의 호환성이 좋으며 레퍼런스가 많은 yarn workspace를 채택하였습니다.

### 모노레포의 단점 극복 방법

- #### 큰 용량과 성능 문제

  프로젝트가 많아질수록 clone시에 용량으로 생기는 문제들이 있었습니다.
  위의 문제는 `git sparse checkout`를 이용하여 원하는 디렉토리만 checkout 하는 형식으로 해결하였습니다.

  ![230904-234635](/posts/8-monorepo/230904-234635.png)

  위와 같이 `client/android` 디렉토리만 사용하고 싶은 경우 아래의 명령어를 입력하면 됩니다.

  ```bash
  git sparse-checkout set client/android
  ```

- #### 무분별한 의존성

  node_modules의 의존성 문제를 `yarn berry의 PnP 모드`를 이용하여 해결하였습니다.

  기존에 사용하고 있던 의존성 디렉토리는 Tree 구조로 Linked List의 탐색 특징을 가지고 있었습니다. 보통의 경우 O(N) 만큼 탐색을 진행해야 하며 File I/O 연산을 하기 때문에 오랜 시간이 걸리는 문제가 있습니다.

  하지만 PnP 모드를 사용하면 의존성에 대한 Mapping Table을 만들어서 탐색하기 때문에 O(1)의 성능을 가지며 JSON 데이터 타입을 사용하여 메모리 내에서 연산을 하기 때문에 File I/O보다 훨씬 좋은 성능을 보여줍니다.

  게다가 의존성에 대한 정보를 압축하여 .zip 파일로 관리하기 때문에 크기면에서도 이점을 가집니다.
