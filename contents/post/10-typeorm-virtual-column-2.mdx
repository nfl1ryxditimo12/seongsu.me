---
title: Typeorm Virtual Column ì„¤ì • (2)
description: TypeORMì—ì„œ ë™ì ì¸ ì—”í‹°í‹°ë¥¼ ë‹¤ë£¨ëŠ” ë°©ë²•
image: '/images/post/10-typeorm-virtual-column-2/cover.png'
tags:
  - Node.js
  - Express
  - TypeScript
  - Typeorm
date: 2022-01-17 03:20:00
---

![typeorm.png](/images/post/10-typeorm-virtual-column-2/cover.png)

<br />

## <ul><li><a href="https://seongsu.me/typeorm-virtual-column-1" target="_blank">Typeorm Virtual Column ì„¤ì • (1)</a></li></ul>

<br />
<br />

ì´ì „ í¬ìŠ¤íŒ…ì—ì„œ `getMany()`í•¨ìˆ˜ì™€ `getRawMany()`í•¨ìˆ˜ì˜ ì°¨ì´ì ì„ ì•Œì•„ë³´ê²Œ ë˜ì—ˆëŠ”ë°<br/>
ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„  ê°€ìƒì»¬ëŸ¼ì„ ì‚¬ìš©í•˜ë©° joinì‹œ ìœ„ í•¨ìˆ˜ì˜ ë¬¸ì œì™€ í•´ê²°ë²•ì„ í¬ìŠ¤íŒ… í•´ë³´ë ¤ í•œë‹¤.<br/>

<br />

## ğŸ˜µâ€ğŸ’« Custom Virtual Columnì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ì´ìœ 

<br />

```TS
// station id 1 ì£¼ë³€ ë§›ì§‘
[
    Shops {
        id: 1,
        stationId: 1,
        shopName: "ë™ì°¬ì´ë„¤"
    },
    Shops {
        id: 2,
        stationId: 1,
        shopName: "ì‚¬ì™•ì´ë„¤"
    },
    Shops {
        id: 3,
        stationId: 1,
        shopName: "ìŠ¹í•œì´ë„¤"
    }
]

// station id 2 ì£¼ë³€ ë§›ì§‘
[
    Shops {
        id: 4,
        stationId: 2,
        shopName: "í¬ë˜í”„íŠ¸ í•œìŠ¤"
    },
    Shops {
        id: 5,
        stationId: 2,
        shopName: "í°í†µì¹˜í‚¨"
    },
    Shops {
        id: 6,
        stationId: 2,
        shopName: "BBQ"
    }
]
```

<br />

ì˜ˆë¥¼ë“¤ì–´ ìœ„ì²˜ëŸ¼ ë²„ìŠ¤ ì •ë¥˜ì†Œì™€ ì£¼ë³€ ë§›ì§‘ì´ ì •ë¥˜ì†Œ pkë¥¼ í†µí•´ foreign keyë¡œ ì—°ê²°ì´ ë˜ì–´ìˆë‹¤ ê°€ì •í•´ ë³´ì.<br/>

<br />

ì´ë ‡ê²Œ ì •ë¥˜ì†Œì™€ ì£¼ë³€ ë§›ì§‘ì˜ ê´€ê³„ê°€ ë§ºì–´ì ¸ ìˆëŠ” ìƒí™©ì—ì„œ í˜„ì¬ ê±°ë¦¬ ê¸°ì¤€ 2km ì´ë‚´ ì •ë¥˜ì†Œ ì£¼ë³€ ë§›ì§‘ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?<br/>

<br />

### <span style={{ color: 'red' }}>getRawMany()ì˜ ë¬¸ì œ</span>

ì§€ê¸ˆ ë³´ë‹ˆ `getRawMany()`í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë‹ˆ ê°€ìƒ ì»¬ëŸ¼ íš¨ê³¼ë¥¼ ë‚¸ ê²ƒ ê°™ì€ë° í•´ê²°ëœê±° ì•„ë‹ˆëƒ? í•  ìˆ˜ ìˆë‹¤.<br/>
ê·¸ëŸ°ë° ë¬¸ì œëŠ” ì§€ê¸ˆë¶€í„°ì´ë‹¤. ì—¬ê¸°ì„œ `inner join` ë˜ëŠ” `left join`ì„ í•  ê²½ìš°<br/>

<br />

`getRawMany()í•¨ìˆ˜ë¡œ join & ê°€ìƒì»¬ëŸ¼`

```TS
[
    Stations {
        stations_id: 1,
        stations_station: "ë™ëŒ€ë¬¸ì—­ 2ë²ˆì¶œêµ¬ ì •ë¥˜ì†Œ",
        stations_latitude: 37.57198805,
        stations_longitude: 127.0117451,
        shops_id: 1,
        shops_stationId: 1,
        shops_shopName: "ë™ì°¬ì´ë„¤",
        distance: 0.4228400907307967
    },
    Stations {
        stations_id: 1,
        stations_station: "ë™ëŒ€ë¬¸ì—­ 2ë²ˆì¶œêµ¬ ì •ë¥˜ì†Œ",
        stations_latitude: 37.57198805,
        stations_longitude: 127.0117451,
        shops_id: 2,
        shops_stationId: 1,
        shops_shopName: "ì‚¬ì™•ì´ë„¤",
        distance: 0.4228400907307967
    },

    ...

    Stations {
        stations_id: 2,
        stations_station: "ì›ë‚¨ë™ ì‚¬ê±°ë¦¬ ì •ë¥˜ì†Œ",
        stations_latitude: 37.57578617,
        stations_longitude: 126.998124,
        shops_id: 5,
        shops_stationId: 2,
        shops_shopName: "í°í†µì¹˜í‚¨",
        distance: 1.5482886513847316
    },
    Stations {
        stations_id: 2,
        stations_station: "ì›ë‚¨ë™ ì‚¬ê±°ë¦¬ ì •ë¥˜ì†Œ",
        stations_latitude: 37.57578617,
        stations_longitude: 126.998124,
        shops_id: 6,
        shops_stationId: 2,
        shops_shopName: "BBQ"
        distance: 1.5482886513847316
    }
]
```

<br />

ìœ„ì²˜ëŸ¼ `distance`ë¥¼ ì¶”ê°€í•´ ì¡°íšŒ í•  ê²½ìš°<br/>
ì›ë˜ ëŒ€ë¡œë©´ ë¶€ëª¨ ê°ì²´ ì•ˆì— joinëœ ê°ì²´ë“¤ì´ ë°°ì—´ì„ ì´ë¤„ ì§€ì •í•œ keyì˜ ë°°ì—´ë¡œ ì €ì¥ì´ ë˜ì–´ì•¼ í•œë‹¤.<br/>
í•˜ì§€ë§Œ `getRawMany()`ë¥¼ ì‚¬ìš©í•˜ë©´ ë¶€ëª¨ê°ì²´ì™€ì˜ ì˜ì¡´ì„±ì´ ëª¨ë‘ ì‚¬ë¼ì§€ë©° joinëœ ê°ì²´ í•˜ë‚˜í•˜ë‚˜ê°€ ë…ë¦½ì ìœ¼ë¡œ ì¡°íšŒëœë‹¤.<br/>
ì—¬ê¸°ì„œ Typeorm ì›ì‹œ ì¿¼ë¦¬ ì¡°íšŒì˜ ë¬¸ì œê°€ ë‚˜ì˜¨ë‹¤.<br/>

<br />

### <span style={{ color: 'red' }}>getMany()ì˜ ë¬¸ì œ</span>

<br />

ê·¸ëŸ¼ `getMany()`í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ë˜ëŠ”ê²ƒ ì•„ë‹ˆëƒ?<br/>
[ì´ì „ í¬ìŠ¤íŒ…](https://seongsu.me/typeorm-virtual-column-1/#code-classlanguage-textgetmany-%EC%82%AC%EC%9A%A9-%EC%8B%9Ccode)ì—ì„œ ë´¤ë˜ ê²ƒ ì²˜ëŸ¼ `distance`ë¥¼ ì¶œë ¥í•˜ê³  ì‹¶ì€ë° ì•ˆë‚˜ì˜¤ëŠ” ë¬¸ì œê°€ ìˆì–´ ìì„¸íˆ ì•Œì•„ë³¼ í•„ìš”ê°€ ì—†ë‹¤.<br/>

<br />

## ğŸ¤© Custom Virtual Columnì„ ì‚¬ìš©í•´ ë³´ì

<br />

ìš°ë¦¬ê°€ ë§Œë“¤ ê°€ìƒ ì»¬ëŸ¼ì€ ìœ„ ë¬¸ì œë¥¼ ì™„ë²½íˆ í•´ê²°í•´ ì¤„ ê²ƒì´ë‹¤.<br/>

> ë¬¼ë¡  ì§œê¸° ë‚˜ë¦„ì´ë‹¤ ğŸ¤ª

<br />

Custom Virtual Columnì„ ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëƒë©´<br/>
ì²«ì§¸ë¡œ ë°ì½”ë ˆì´í„° ì„¤ì •, ê°€ìƒ ì»¬ëŸ¼ ì„¤ì •, ê·¸ ë’¤ `getMany()`, `getRawMany()`ë¥¼ ëŒ€ì²´í•  í•¨ìˆ˜ ì œì‘ì´ë‹¤.<br/>
ê·¸ëŸ¼ `addSelect()`í•¨ìˆ˜ê°€ í˜¸ì¶œ ë  ë•Œ alias ëœ ì»¬ëŸ¼ëª…ìœ¼ë¡œ ë°ì½”ë ˆì´í„°ê°€ ë“±ë¡ëœ ì»¬ëŸ¼ì´ ì ìš©ë  ê²ƒì´ë‹¤.<br/>

<br />

- https://typescript-kr.github.io/pages/decorators.html<br/>

  ë¨¼ì € ìœ„ ë§í¬ì—ì„œ ë°ì½”ë ˆì´í„° & ë©”íƒ€ë°ì´í„°ì— ê´€í•´ ì•Œì•„ë³´ì<br/>

<br />

ê·¸ ë’¤ `reflect-metadata`ì„¤ì¹˜ê°€ ì™„ë£Œ ë˜ì—ˆê³  `tsconfig.json`ì— ë©”íƒ€ë°ì´í„° ì„¤ì •ì´ ì™„ë£Œ ë˜ì—ˆë‹¤ë©´ ë°ì½”ë ˆì´í„°ë¥¼ ë§Œë“¤ì–´ ì£¼ì.

<br />

### `@modules/decorator.ts`

```TS
import "reflect-metadata";

const COLUMN_KEY = Symbol("VIRTUAL_COLUMN");

export function VirtualColumn(name?: string): PropertyDecorator {
    return (target, propertyKey) => {
        const metaInfo = Reflect.getMetadata(COLUMN_KEY, target) || {};

        metaInfo[propertyKey] = name ?? propertyKey;

        Reflect.defineMetadata(COLUMN_KEY, metaInfo, target);
    };
}
```

<br />

ë°ì½”ë ˆì´í„° í•¨ìˆ˜ ì‘ì„±ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©´ Entityì— ë°”ë¡œ ì ìš©í•˜ì!<br/>

<br />

### `@entities/stations.ts`

```TS
import { Entity, PrimaryGeneratedColumn, Column } from "typeorm";
import { VirtualColumn } from "@modules/decorator.ts";

@Entity("stations")
export class Stations {
    @PrimaryGeneratedColumn()
    id: number;

    @Column("varchar")
    station: string;

    @Column("double")
    latitude: number;

    @Column("double")
    longitude: number;

    // ë°ì½”ë ˆì´í„°ëŠ” distanceë¼ëŠ” ì´ë¦„ì„ ê°€ì§„ ì»¬ëŸ¼ìœ¼ë¡œ ì¸ì‹í•˜ê²Œ ëœë‹¤.
    @VirtualColumn()
    distance: number;
}
```

<br />

ì´ì œ Express ì„œë²„ê°€ ì‹¤í–‰ë˜ë©° Typeormì´ ì—°ê²°ë  ë•Œ VirtualColumn()ë„ ê°™ì´ ì ìš©ëœë‹¤.<br/>
ê·¸ ë’¤ ìš°ë¦¬ê°€ ì›í•˜ëŠ” ê²°ê³¼ë¥¼ ì–»ê¸° ìœ„í•´ `getRawMany()`í•¨ìˆ˜ë¥¼ ì»¤ìŠ¤í…€ í•´ë³´ì.<br/>

<br />

### `@modules/queryBuilder.ts`

```TS
import { SelectQueryBuilder } from "typeorm";
import "reflect-metadata";

declare module "typeorm" {
    interface SelectQueryBuilder<Entity> {
        getAroundShop(this: SelectQueryBuilder<Entity>): Promise<Entity[] | undefined>;
    }
}

const COLUMN_KEY = Symbol("VIRTUAL_COLUMN");

SelectQueryBuilder.prototype.getAroundShop = async function () {
    // ë¨¼ì € ì›ì‹œ ë°ì´í„° ì¡°íšŒ ê²°ê³¼ë¥¼ ì–»ì–´ì˜¨ë‹¤
    const { entities, raw } = await this.getRawAndEntities();
    let flag = 0;
    let idx = 0;

    const items = entities.map((entitiy) => {
        // ì›ì‹œ ê²°ê³¼ì—ì„œ í•„ìš”ì—†ëŠ” ë°ì´í„°ë¥¼ ì³ë‚´ê¸° ìœ„í•´ ë°˜ë³µë¬¸ì„ ëŒë ¤ì¤€ë‹¤.
        while (flag === raw[idx]["staions_id"]) {
            idx++;
        }

        // ì•ì „ì— ì‘ì„±í•œ ë°ì½”ë ˆì´í„°ë¥¼ COLUMN_KEYë¡œ ì¸ì‹í•˜ê²Œ í•œë‹¤.
        const metaInfo = Reflect.getMetadata(COLUMN_KEY, entitiy) ?? {};
        const item = raw[idx];

        for (const [propertyKey, name] of Object.entries<string>(metaInfo)) {
            entitiy[propertyKey] = item[name];
        }

        flag = item["stations_id"];
        return entitiy;
    });

    // distanceë¥¼ í¬í•¨í•œ ë°ì´í„°ë¥¼ ë°˜í™˜í•´ì¤€ë‹¤.
    return [...items];
};
```

<br />

ì´ë ‡ê²Œ ë˜ë©´ ê¸°ì¡´ Typeormì˜ `getRawMany()`ì˜ ê¸°ëŠ¥ê³¼ ê±°ì˜ ë¹„ìŠ·í•˜ê²Œ ë§Œë“  `getAroundShop()`í•¨ìˆ˜ê°€ ë§Œë“¤ì–´ ì¡Œë‹¤.<br/>
ì´ë ‡ê²Œ ë˜ë©´ ì›ë˜ ì›í–ˆë˜ ë¶€ëª¨ ê°ì²´ ì•ˆì— joinëœ ê°ì²´ë“¤ì´ ë°°ì—´ì„ ì´ë¤„ ë°˜í™˜ì´ ë  ê²ƒì´ë‹¤.<br/>

<br />

### `getAroundShop() ì‚¬ìš© ì‹œ`

```TS
import { getRepository } from "typeorm";
import { getAroundShop } from "@modules/queryBuilder";
import { Stations } from "@entities/stations";
import { Shops } from "@entities/shops";

/**
    lat: 37.57418192,
    lon: 127.015664,
    radius(ê¸°ì¤€ km): 2
*/
const aroundStation = async (lat: number, lon: number, radius: number) => {
    return await getRepository(Stations)
        .createQueryBuilder("stations")
        .select()
        .addSelect(
                `6371 * acos(cos(radians(${lat})) * cos(radians(latitude)) * cos(radians(longitude) - radians(${lon})) + sin(radians(${lat})) * sin(radians(latitude)))`,
                "distance"
            )
        .leftJoinAndSelect("stations.shops", "shops")
        .having(`distance <= ${radius}`)
        .orderBy("distance", "ASC")
        .getAroundShop();
}

console.log(aroundStation());
```

> Entity joiní•˜ëŠ” ë°©ë²•ì€ [Typeorm ê³µì‹ë¬¸ì„œ](https://typeorm.io)ë¥¼ ì°¸ì¡°í•˜ì!

<br />

## ğŸ¥³ ê°€ìƒ ì»¬ëŸ¼ì„ í†µí•œ ë°ì´í„° ì¡°íšŒ

<br />

```TS
[
    Stations {
        id: 1,
        station: "ë™ëŒ€ë¬¸ì—­ 2ë²ˆì¶œêµ¬ ì •ë¥˜ì†Œ",
        latitude: 37.57198805,
        longitude: 127.0117451,
        shops: [
            {
                id: 1,
                stationId: 1,
                shopName: "ë™ì°¬ì´ë„¤"
            },
            {
                id: 2,
                stationId: 1,
                shopName: "ì‚¬ì™•ì´ë„¤"
            },
            {
                id: 3,
                stationId: 1,
                shopName: "ìŠ¹í•œì´ë„¤"
            }
        ],
        distance: 0.4228400907307967
    },
    Stations {
        id: 2,
        station: "ì›ë‚¨ë™ ì‚¬ê±°ë¦¬ ì •ë¥˜ì†Œ",
        latitude: 37.57578617,
        longitude: 126.998124,
        shops: [
            {
                id: 4,
                stationId: 2,
                shopName: "í¬ë˜í”„íŠ¸ í•œìŠ¤"
            },
            {
                id: 5,
                stationId: 2,
                shopName: "í°í†µì¹˜í‚¨"
            },
            {
                id: 6,
                stationId: 2,
                shopName: "BBQ"
            }
        ],
        distance: 1.5482886513847316
    },
]
```

<br />

ì´ë¡œì¨ í…Œì´ë¸”ì— ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŠ¹ì • ë°ì´í„°ë¥¼ í¬í•¨í•´ ì¡°íšŒí•˜ëŠ” ë¡œì§ì„ ì™„ì„±í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤.<br/>
ì´ê²Œ íŠ¹ë³„í•œ ê¸°ëŠ¥ì€ ì•„ë‹Œê²ƒ ê°™ì€ë° Typeormì—ì„œ ì •ì‹ìœ¼ë¡œ ì§€ì›í•´ ì£¼ì§€ ì•ŠëŠ” ë°”ëŒì— ëª‡ì¼ ê°œê³ ìƒì„ í•´ì„œ ì°¾ê³  êµ¬í˜„ì„ í•˜ê²Œ ë˜ì—ˆë‹¤.<br/>
í›„...ğŸ˜‘ ì™œ ì´ë ‡ê²Œ í•„ìš”í•˜ê³  ì´ê²Œ ì•ˆë¼? ë¼ëŠ” ê¸°ëŠ¥ì´ ê³µì‹ ì§€ì›ì´ ì•ˆë¼ ê°œê³ ìƒì„ í•´ì•¼í•˜ëŠ”ì§€ ëª¨ë¥´ê² ì§€ë§Œ... ì–´ì¨‹ë“  ê²°ê³¼ê°€ ì¢‹ì•˜ìœ¼ë‹ˆ ëœê²ƒ ê°™ë‹¤...ğŸ˜…<br/>

> 0.2.37 ë²„ì „ì—ì„œ ì§€ì› í•´ì¤€ë‹¤ í–ˆìœ¼ë©´ì„œ ì•„ì§ë„ ì•ˆí•´ì£¼ë„¤...

<br />

## ğŸ“š ì°¸ê³  ìë£Œ

- Virtual Column solutions for TypeORM

> https://pietrzakadrian.com/blog/virtual-column-solutions-for-typeorm

<br />
<br />
