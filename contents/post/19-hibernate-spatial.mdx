---
title: Hibernate Spatialì„ ì´ìš©í•œ ì¢Œí‘œê°„ ê±°ë¦¬ê³„ì‚° (feat. PostGIS, H2GIS)
description: Geometric APIë¥¼ ì´ìš©í•˜ì—¬ ì¢Œí‘œ ê°„ ê±°ë¦¬ë¥¼ ì‰½ê²Œ êµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
image: '/images/post/19-hibernate-spatial/cover.webp'
tags:
  - Spring
  - Hibernate
  - PostgreSQL
  - H2
date: 2022-11-20 13:17:00
---

![hibernate logo](/images/post/19-hibernate-spatial/Hibernate_logo.png)

<br />

## ğŸ’½ Hibernate Spatial

<br />

Hibernate Spatialì€ ì§€ë¦¬ ë°ì´í„°ë¥¼ ê³„ì‚°í•˜ê¸° ìœ„í•´ ë§Œë“¤ì–´ ì¡Œê³ , Hibernate 5.0 ë²„ì „ ë¶€í„° Hibernate ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ê³µì‹ì ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ëë‹¤.<br />

í˜„ì¬ ì§€ì›í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ëŠ” `Oracle`, `PostgreSQL`, `MySQL`, `MSSQL`, `H2`ì´ê³ , ê° ë°ì´í„°ë² ì´ìŠ¤ì— êµ¬í˜„ ë˜ì–´ìˆëŠ” ì§€ë¦¬ ë°ì´í„°ì²˜ë¦¬ êµ¬í˜„ì²´ë¥¼ ì¶”ìƒí™”í•œ ì¸í„°í˜ì´ìŠ¤ê°€ `Hibernate Spatial`ì´ë‹¤.<br />

Hibernate Spatialì€ [JTS](https://www.tsusiatsoftware.net/jts/main.html)ì™€ [
geolatte-geom](https://github.com/GeoLatte/geolatte-geom)ì´ë¼ëŠ” ê¸°í•˜í•™ ëª¨ë¸ì„ ì œê³µí•œë‹¤ê³  í•œë‹¤.<br />

ì´ëŸ¬í•œ GIS(Geometry Information System)ë¥¼ `Native Query`ë¡œ ë‚ ë¦¬ì§€ ì•Šê³  Hibernateì— ì¶”ìƒí™”ëœ í•¨ìˆ˜ë¥¼ í†µí•´ JPQLë¡œ ì‰½ê²Œ ì§¤ ìˆ˜ ìˆë‹¤.<br />

<br />

### ğŸ‘ˆ ì–´ë–¤ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•´ì•¼ í• ê¹Œ?

<br />

![hibernate function](/images/post/19-hibernate-spatial/hibernate-function.png)

> [Hibernate Spatial Function](https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#spatial-configuration)

<br />

Geometry í•¨ìˆ˜ë¥¼ ì§€ì›í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ëŠ” ë§ì´ ìˆë‹¤. í•˜ì§€ë§Œ ì´ í¬ìŠ¤íŒ…ì—ì„œ ì‘ì„±í•  ë‚´ìš©ì¸ `ST_Distance`, `ST_Dwithin`ê³¼ ê°™ì€ ì¢Œí‘œ ê°„ ê±°ë¦¬ë¥¼ ê°„ë‹¨í•˜ê²Œ ë°˜í™˜í•´ì£¼ëŠ” í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê¸°ì—” ì´ì‹ì„±ì´ ë–¨ì–´ì§€ëŠ” ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¡´ì¬í•œë‹¤.<br />

ì›ë˜ëŠ” MySQLì„ ì‚¬ìš©í•˜ë ¤ í–ˆì§€ë§Œ, ìœ„ ê±°ë¦¬ê³„ì‚° í•¨ìˆ˜ë¥¼ Hibernateì—ì„œ ì§€ì›í•˜ì§€ ì•Šì•„ `Native Query`ë¡œ ì‚¬ìš©í•´ì•¼ ë¼ ORMì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ë¥¼ ì°¾ì§€ ëª»í•´ PostreSQLì„ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆë‹¤.<br />

ë˜í•œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ H2 Databaseë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ë°, H2GISê°€ PostGISë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì œì‘ë˜ì–´ì„œ í…ŒìŠ¤íŠ¸ê°€ ìš©ì´í•œ ì´ìœ ë„ ìˆë‹¤.<br />

<br />

## â¬‡ï¸ PostgreSQL, PostGIS ì„¤ì¹˜

<br />

ìš°ì„  ì›í•˜ëŠ” PostgreSQLì„ ì„¤ì¹˜í•˜ê³ , PostgreSQLë¡œ ì§€ë¦¬ê³„ì‚°ì„ í•˜ë ¤ë©´ `PostGIS` ë¼ì´ë¸ŒëŸ¬ë¥¼ ì„¤ì¹˜í•´ì•¼ í•œë‹¤.<br />

`PostgreSQL ì„¤ì¹˜ ë°©ë²•ê³¼ ë²„ì „ì€ ë„ˆë¬´ ê°„ë‹¨í•˜ë‹ˆ íŒ¨ìŠ¤!`<br />

> [PostGIS Relase](https://postgis.net/tags/3/)

<br />

![postgis relase](/images/post/19-hibernate-spatial/postgis-relase.png)

> ìœ„ ë§í¬ì—ì„œ ë¦´ë¦¬ì¦ˆ ë²„ì „ì„ ì„ íƒí•  ë•Œ ì§€ì›í•˜ëŠ” PostgreSQL ë²„ì „ì„ ê¼­ í™•ì¸í•´ì•¼ í•œë‹¤!

<br />

PostgreSQL, PostGIS ì„¤ì¹˜ê°€ ëª¨ë‘ ëë‚¬ìœ¼ë©´, Extension ì„¤ì •ì„ ë‹¤ìŒê³¼ ê°™ì´ í•´ì¤˜ì•¼ í•œë‹¤.<br />

```SQL
CREATE EXTENSION postgis;
```

ì´ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì§€ë¦¬ë°ì´í„° ê³„ì‚° í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê³ , ì§€ë¦¬ë°ì´í„° íƒ€ì…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤.<br />

PostGIS ì§€ë¦¬ í•¨ìˆ˜ì— ëŒ€í•´ì„  ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•´ë³´ì<br />

> [PostGIS Special Functions Index](https://postgis.net/docs/manual-1.5/ch08.html)

<br />

## âœï¸ Hibernate ì„¤ì¹˜ ë° ì„¤ì •

<br />

ìš°ì„  Gradleì„¤ì •ì„ í•´ì¤€ë‹¤.<br />

```gradle
plugins {
    id 'org.springframework.boot' version '2.7.5'
}

dependencies {
  implementation 'org.springframework.boot:spring-boot-starter-web'
  implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
  implementation group: 'org.hibernate', name: 'hibernate-spatial'
  implementation group: 'org.postgresql', name: 'postgresql'
  runtimeOnly 'org.postgresql:postgresql'
}
```

Springì€ `2.7.5`ë²„ì „ì„ ì‚¬ìš©í•  ì˜ˆì •ì´ê³  HibernateëŠ” `spring-boot-starter`ì— ëª…ì‹œëœ ë²„ì „ì„ ì‚¬ìš©í•  ê²ƒì´ë‹¤.<br />

ê·¸ë¦¬ê³  `hibernate-spatial`, `jpa`, `postgresql` implementationì„ ì¶”ê°€í•´ì¤€ë‹¤.<br />

Spring boot ë²„ì „ ë³„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„±ì€ [ìŠ¤í”„ë§ë¶€íŠ¸ ê³µì‹ í˜ì´ì§€](https://spring.io/blog)ì— ì˜ ë‚˜ì™€ìˆë‹¤!<br />

> [Spring boot 2.7.5 ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„±ì€ ì—¬ê¸°ì„œ í™•ì¸](https://docs.spring.io/spring-boot/docs/2.7.5/reference/html/dependency-versions.html#appendix.dependency-versions)

<br />

### âš™ï¸ application.yml ì„¤ì •

<br />

```yml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/test_db # DB host
    username: username # DB username
    password: password # DB password
    driver-class-name: org.postgresql.Driver # DB driver
  jpa:
    hibernate:
      ddl-auto: create # ì‘ì„±ëœ entityì— ë”°ë¼ ìŠ¤í‚¤ë§ˆ ìë™ ìƒì„±
      use-new-id-generator-mappings: true # pk ì„¤ì •
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true
    # ì¤‘ìš”!!
    database-platform: org.hibernate.spatial.dialect.postgis.PostgisDialect
```

<br />

ìœ„ì—ì„œ ì¤‘ìš”í•œ ë¶€ë¶„ì€ `spring.jpa.database-platform`ì´ê³ , ì´ ë¶€ë¶„ì€ Hibernate Spatialì˜ ì§€ë¦¬ í•¨ìˆ˜ë¥¼ ì¼ì„ ë•Œ PostGIS í•¨ìˆ˜ë¡œ ë§¤í•‘í•´ì£¼ëŠ” Dialect ì„¤ì •ì´ë‹¤.<br />

PostgreSQL 10ë²„ì „ ì´ìƒë¶€í„°ëŠ” ìœ„ ì½”ë“œì˜ Dialectë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤ê³  í•œë‹¤.<br />

PostgreSQL ë²„ì „ì— ë”°ë¼ Dialectê°€ ë‹¤ë¥¸ë° ì´ëŠ” ì•„ë˜ ë§í¬ì— ì²¨ë¶€í•˜ê² ë‹¤.<br />

> [Package org.hibernate.spatial.dialect.postgis](https://docs.jboss.org/hibernate/orm/5.4/javadocs/org/hibernate/spatial/dialect/postgis/package-summary.html)

<br />

### ğŸ”Œ JPQLë¡œ ì‘ì„±í•œ GIS í•¨ìˆ˜

<br />

```Java

...

import org.locationtech.jts.geom.Point;
import javax.persistence.*;

@Entity
public class Test {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id", unique = true, nullable = false)
    private Long id;

    @Column(name = "name", nullable = false)
    private String name;

    @Column(name = "gps", nullable = false)
    private Point gps;

}
```

<br />

ìš°ì„  ê±°ë¦¬ ê³„ì‚°ì„ ìœ„í•´ `Test` ì—”í‹°í‹°ë¥¼ ì‘ì„±í•´ ì£¼ê³ , `Geometry` íƒ€ì…ì¸ Point íƒ€ì…ì„ ì´ìš©í•´ ì»¬ëŸ¼ì„ ì‘ì„±í•´ ì¤€ë‹¤.<br />

<br />

```Java
public interface TestRepository extends JpaRepository<Test, Long> {

    /*
        dwithin í•¨ìˆ˜ëŠ” ë°˜ê²½(ë‹¨ìœ„: m) ë‚´ì— ì¡´ì¬í•˜ëŠ”ì§€ boolean ê°’ìœ¼ë¡œ ì‘ë‹µí•¨
        4ë²ˆì§¸ ì¸ìëŠ” í‰ë©´ì—ì„œ êµ¬í•  ê²ƒì¸ì§€, êµ¬ì—ì„œ êµ¬í•  ê²ƒì¸ì§€ ì •í•˜ëŠ” flagë¡œ falseì¸ ê²½ìš° êµ¬ì—ì„œ ê±°ë¦¬ë¥¼ ê³„ì‚°í•¨
    */
    @Query(value = "select t from Test t where dwithin(t.gps, :point, 30000, false) = true")
    List<Test> findTestByDistance(@Param("point") Point point);

}
```

<br />

ê·¸ ë’¤ Repositoryì—ì„œ `JPQL`ì„ ì‚¬ìš©í•˜ì—¬ whereì ˆì— GIS í•¨ìˆ˜ì¸ `dwithin`ì„ ì‚¬ìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ ì¢Œí‘œì™€ì˜ ê±°ë¦¬ê³„ì‚°ì„ í†µí•´ Listë¡œ ì‘ë‹µì„ ë°›ê²Œ ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.<br />

> [Dwithinì´ë€? (PostGIS ST_Dwithin)](https://postgis.net/docs/ST_DWithin.html)

<br />

Hibernateì— ì •ì˜ëœ ë‚´ìš©ì— ë”°ë¥´ë©´, ë‘ Geometry(Point)íƒ€ì…ê³¼ Double í˜•ì¸ distanceë¥¼ ì‚¬ìš©í•˜ì—¬ ë‘ ì¢Œí‘œê°„ ê±°ë¦¬ê°€ distance ë‚´ì— í¬í•¨ë˜ëŠ”ì§€ `boolean` í˜•íƒœë¡œ ë¦¬í„´í•´ ì£¼ëŠ” í•¨ìˆ˜ì´ë‹¤.<br />

> distance ê¸°ì¤€ì€ ë¯¸í„°ì´ë‹¤.

<br />

![st_dwithin](/images/post/19-hibernate-spatial/st_diwthin.png)

> PostGIS description

<br />

ìœ„ ë ˆí¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ë³´ë©´, 4ë²ˆì§¸ ì¸ìë¡œ booleanì´ ì¶”ê°€ë˜ì—ˆëŠ”ë°<br />
ì´ëŠ” ì£¼ì„ì— ì í˜€ìˆëŠ” ê²ƒì²˜ëŸ¼ `êµ¬`ì—ì„œ ê±°ë¦¬ ê³„ì‚°ì„ í•  ê²ƒì¸ì§€, `í‰ë©´`ì—ì„œ ê³„ì‚°í•  ê²ƒì¸ì§€ ë‚˜íƒ€ë‚´ëŠ” ê°’ìœ¼ë¡œ ìœ„ë„, ê²½ë„ë¥¼ ì´ìš©í•œ ê±°ë¦¬ ê³„ì‚°ì´ í•„ìš”í•˜ë‹¤ë©´ `true`ë¡œ ì¸ìë¥¼ ì „ë‹¬í•˜ë©´ ëœë‹¤.<br />

<br />

<br />
<br />
